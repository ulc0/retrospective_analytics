-- Databricks notebook source
-- MAGIC %md #Inpatient

-- COMMAND ----------

-- MAGIC %md ##Inpatient Encounter Strict

-- COMMAND ----------

--CREATE OR REPLACE TEMP VIEW inpatient_class_codes AS
SELECT *
FROM cdh_truveta.Concept
WHERE ConceptCode IN 
("1065220",
"1065215",
"1065223"
);

--SELECT *
--FROM inpatient_class_codes

-- COMMAND ----------

CREATE OR REPLACE TEMP VIEW inpatient_type_codes AS
SELECT *
FROM edav_prd_cdh.cdh_global_reference_etl.bronze_athena_concept
WHERE ConceptCode IN 
("3059272",
"1065297"
);

SELECT *
FROM inpatient_type_codes

-- COMMAND ----------

select *
from cdh_truveta.Encounter
limit 10

-- COMMAND ----------

CREATE OR REPLACE TEMP VIEW inpatient_encounter_strict AS
SELECT * 
FROM cdh_truveta.Encounter e 
WHERE e.ClassConceptId IN (SELECT ConceptId FROM inpatient_class_codes) 
AND (e.TypeConceptId IN (SELECT ConceptId FROM inpatient_type_codes) or e.TypeConceptId IS NOT NULL)
AND e.EndDateTime IS NOT NULL

-- COMMAND ----------

-- MAGIC %md ## Inpatient Encounter Loose

-- COMMAND ----------

CREATE OR REPLACE TEMP VIEW inpatient_class_codes_loose AS
SELECT *
FROM edav_prd_cdh.cdh_global_reference_etl.bronze_athena_concept
WHERE ConceptCode IN 
("1065297",
  "1065603",
  "1065302",
  "1065215",
  "1065223",
  "1065220",
  "1065223",
  "1065304",
  "1065305",
  "1065306",
  "1065307"
);

SELECT *
FROM inpatient_class_codes_loose

-- COMMAND ----------

CREATE OR REPLACE TEMP VIEW inpatient_type_codes_loose AS
SELECT *
FROM edav_prd_cdh.cdh_global_reference_etl.bronze_athena_concept
WHERE ConceptCode IN 
("1065302",
  "1065215",
  "1065223",
  "1065220",
  "1065223",
  "1065304",
  "1065305",
  "1065306",
  "1065307"
);

SELECT *
FROM inpatient_type_codes_loose

-- COMMAND ----------

CREATE OR REPLACE TEMP VIEW inpatient_encounter_loose AS
SELECT e.* 
FROM cdh_truveta.Encounter e 
WHERE e.ClassConceptId IN (SELECT ConceptId FROM inpatient_class_codes_loose) 
OR e.TypeConceptId IN (SELECT ConceptId FROM inpatient_type_codes_loose) 

-- COMMAND ----------

-- MAGIC %md # Race Categories

-- COMMAND ----------

CREATE OR REPLACE TEMP VIEW t_race AS
SELECT *, CASE 
WHEN RaceConceptId IN ('1066466', '1066467', '1066468', '1066469', '1066470', '1066471', '1066472', '1066473', '1066474', '1066475', '1066476', '1066477', '1066478', '1066479', '1066480', '1066481', '1066482', '1066483', '1066484', '1066485', '1066486', '1066487', '1066488', '1066489', '1066490', '1066491', '1066492', '1066493', '1066494', '1066495', '1066496', '1066497', '1066498', '1066499', '1066500', '1066501', '1066502', '1066503', '1066504', '1066505', '1066506', '1066507', '1066508', '1066509', '1066510', '1066511', '1066512', '1066513', '1066514', '1066515', '1066516', '1066517', '1066518', '1066519', '1066520', '1066521', '1066522', '1066523', '1066524', '1066525', '1066526', '1066527', '1066528', '1066529', '1066530', '1066531', '1066532', '1066533', '1066534', '1066535', '1066536', '1066537', '1066538', '1066539', '1066540', '1066541', '1066542', '1066543', '1066544', '1066545', '1066546', '1066547', '1066548', '1066549', '1066550', '1066551', '1066552', '1066553', '1066554', '1066555', '1066556', '1066557', '1066558', '1066559', '1066560', '1066561', '1066562', '1066563', '1066564', '1066565', '1066566', '1066567', '1066568', '1066569', '1066570', '1066571', '1066572', '1066573', '1066574', '1066575', '1066576', '1066577', '1066578', '1066579', '1066580', '1066581', '1066582', '1066583', '1066584', '1066585', '1066586', '1066587', '1066588', '1066589', '1066590', '1066591', '1066592', '1066593', '1066594', '1066595', '1066596', '1066597', '1066598', '1066599', '1066600', '1066601', '1066602', '1066603', '1066604', '1066605', '1066606', '1066607', '1066608', '1066609', '1066610', '1066611', '1066612', '1066613', '1066614', '1066615', '1066616', '1066617', '1066618', '1066619', '1066620', '1066621', '1066622', '1066623', '1066624', '1066625', '1066626', '1066627', '1066628', '1066629', '1066630', '1066631', '1066632', '1066633', '1066634', '1066635', '1066636', '1066637', '1066638', '1066639', '1066640', '1066641', '1066642', '1066643', '1066644', '1066645', '1066646', '1066648', '1066649', '1066650', '1066651', '1066652', '1066653', '1066654', '1066655', '1066656', '1066657', '1066658', '1066659', '1066660', '1066661', '1066662', '1066663', '1066664', '1066665', '1066666', '1066667', '1066668', '1066669', '1066670', '1066671', '1066672', '1066673', '1066674', '1066675', '1066676', '1066677', '1066678', '1066679', '1066680', '1066681', '1066682', '1066683', '1066684', '1066685', '1066686', '1066687', '1066688', '1066689', '1066690', '1066691', '1066692', '1066693', '1066694', '1066695', '1066696', '1066697', '1066698', '1066699', '1066700', '1066701', '1066702', '1066703', '1066704', '1066705', '1066706', '1066707', '1066708', '1066709', '1066710', '1066711', '1066712', '1066713', '1066714', '1066715', '1066716', '1066717', '1066718', '1066719', '1066720', '1066721', '1066722', '1066723', '1066724', '1066725', '1066726', '1066727', '1066728', '1066729', '1066730', '1066731', '1066732', '1066733', '1066734', '1066735', '1066736', '1066737', '1066738', '1066739', '1066740', '1066741', '1066742', '1066743', '1066744', '1066745', '1066746', '1066747', '1066748', '1066749', '1066750', '1066751', '1066752', '1066753', '1066754', '1066755', '1066756', '1066757', '1066758', '1066759', '1066760', '1066761', '1066762', '1066763', '1066764', '1066765', '1066766', '1066767', '1066768', '1066769', '1066770', '1066771', '1066772', '1066773', '1066774', '1066775', '1066776', '1066777', '1066778', '1066779', '1066780', '1066781', '1066782', '1066783', '1066784', '1066785', '1066786', '1066787', '1066788', '1066789', '1066790', '1066791', '1066792', '1066793', '1066794', '1066795', '1066796', '1066797', '1066798', '1066799', '1066800', '1066801', '1066802', '1066803', '1066804', '1066805', '1066806', '1066807', '1066808', '1066809', '1066810', '1066811', '1066812', '1066813', '1066814', '1066815', '1066816', '1066817', '1066818', '1066819', '1066820', '1066821', '1066822', '1066823', '1066824', '1066825', '1066826', '1066827', '1066828', '1066829', '1066830', '1066831', '1066832', '1066833', '1066834', '1066835', '1066836', '1066837', '1066838', '1066839', '1066840', '1066841', '1066842', '1066843', '1066844', '1066845', '1066846', '1066847', '1066848', '1066849', '1066850', '1066851', '1066852', '1066853', '1066854', '1066855', '1066856', '1066857', '1066858', '1066859', '1066860', '1066861', '1066862', '1066863', '1066864', '1066865', '1066866', '1066867', '1066868', '1066869', '1066870', '1066871', '1066872', '1066873', '1066874', '1066875', '1066876', '1066877', '1066878', '1066879', '1066880', '1066881', '1066882', '1066883', '1066884', '1066885', '1066886', '1066887', '1066888', '1066889', '1066890', '1066891', '1066892', '1066893', '1066894', '1066895', '1066896', '1066897', '1066898', '1066899', '1066900', '1066901', '1066902', '1066903', '1066904', '1066905', '1066906', '1066907', '1066908', '1066909', '1066910', '1066911', '1066912', '1066913', '1066914', '1066915', '1066916', '1066917', '1066918', '1066919', '1066920', '1066921', '1066922', '1066923', '1066924', '1066925', '1066926', '1066927', '1066928', '1066929', '1066930', '1066931', '1066932', '1066933', '1066934', '1066935', '1066936', '1066937', '1066938', '1066939', '1066940', '1066941', '1066942', '1066943', '1066944', '1066945', '1066946', '1066947', '1066948', '1066949', '1066950', '1066951', '1066952', '1066953', '1066954', '1066955', '1066956', '1066957', '1066958', '1066959', '1066960', '1066961', '1066962', '1066963', '1066964', '1066965', '1066966', '1066967', '1066968', '1066969', '1066970', '1066971', '1066972', '1066973', '1066974', '1066975', '1066976', '1066977', '1066978', '1066979', '1066980', '1066981', '1066982', '1066983', '1066984', '1066985', '1066986', '1066987', '1066988', '1066989', '1066990', '1066991', '1066992', '1066993', '1066994', '1066995', '1066996', '1066997', '1066998', '1066999', '1067000', '1067001', '1067002', '1067003', '1067004', '1067005', '1067006', '1067007', '1067008', '1067009', '1067010', '1067011', '1067012', '1067013', '1067014', '1067015', '1067016', '1067017', '1067018', '1067019', '1067020', '1067021', '1067022', '1067023', '1067024', '1067025', '1067026', '1067027', '1067028', '1067029', '1067030', '1067031', '1067032', '1067033', '1067034', '1067035', '1067036', '1067037', '1067038', '1067039', '1067040', '1067041', '1067042', '1067043', '1067044', '1067045', '1067046', '1067047', '1067048', '1067049', '1067050', '1067051', '1067052', '1067053', '1067054', '1067055', '1067056', '1067057', '1067058', '1067059', '1067060', '1067061', '1067062', '1067063', '1067064', '1067065', '1067066', '1067067', '1067068', '1067069', '1067070', '1067071', '1067072', '1067073', '1067074', '1067075', '1067076', '1067077', '1067078', '1067079', '1067080', '1067081', '1067082', '1067083', '1067084', '1067085', '1067086', '1067087', '1067088', '1067089', '1067090', '1067091', '1067092', '1067093', '1067094', '1067095', '1067096', '1067097', '1067098', '1067099', '1067100', '1067101', '1067102', '1067103', '1067104', '1067105', '1067106', '1067107', '1067108', '1067109', '1067110', '1067111', '1067112', '1067113', '1067114', '1067115', '1067116', '1067117', '1067118', '1067119', '1067120', '1067121', '1067122', '1067123', '1067124', '1067125', '1067126', '1067127', '1067128', '1067129', '1067130', '1067131', '1067132', '1067133', '1067134', '1067135', '1067136', '1067137', '1067138', '1067139', '1067140', '1067141', '1067142', '1067143', '1067144', '1067145', '1067146', '1067147', '1067148', '1067149', '1067150', '1067151', '1067152', '1067153', '1067154', '1067155', '1067156', '1067157', '1067158', '1067159', '1067160', '1067161', '1067162', '1067163', '1067164', '1067165', '1067166', '1067167', '1067168', '1067169', '1067170', '1067171', '1067172', '1067173', '1067174', '1067175', '1067176', '1067177', '1067178', '1067179', '1067180', '1067181', '1067182', '1067183', '1067184', '1067185', '1067186', '1067187', '1067188', '1067189', '1067190', '1067191', '1067192', '1067193', '1067194', '1067195', '1067196', '1067197', '1067198', '1067199', '1067200', '1067201', '1067202', '1067203', '1067204', '1067205', '1067206', '1067207', '1067208', '1067209', '1067210', '1067211', '1067212', '1067213', '1067214', '1067215', '1067216', '1067217', '1067218', '1067219', '1067220', '1067221', '1067222', '1067223', '1067224', '1067225', '1067226', '1067227', '1067228', '1067229', '1067230', '1067231', '1067232', '1067233', '1067234', '1067235', '1067236', '1067237', '1067238', '1067239', '1067240', '1067241', '1067242', '1067243', '1067244', '1067245', '1067246', '1067247', '1067248', '1067249', '1067250', '1067251', '1067252', '1067253', '1067254', '1067255', '1067256', '1067257', '1067258', '1067259', '1067260', '1067261', '1067262', '1067263', '1067264', '1067265', '1067266', '1067267', '1067268', '1067269', '1067270', '1067271', '1067272', '1067273', '1067274', '1067275', '1067276', '1067277', '1067278', '1067279', '1067280', '1067281', '1067282', '1067283', '1067284', '1067285', '1067286', '1067287', '1067288', '1067289', '1067290', '1067291', '1067292', '1067293')
THEN "American Indian or Alaska Native"
WHEN RaceConceptId IN ('1067294', '1067295', '1067296', '1067297', '1067298', '1067299', '1067300', '1067301', '1067302', '1067303', '1067304', '1067305', '1067306', '1067307', '1067308', '1067309', '1067310', '1067311', '1067312', '1067313', '1067314', '1067315', '1067316', '1067317', '1067318')
THEN "Asian"
WHEN RaceConceptId IN ('1067319', '1067320', '1067321', '1067322', '1067323', '1067324', '1067325', '1067326', '1067327', '1067328', '1067329', '1067330', '1067331', '1067332', '1067333', '1067334', '1067335', '1067336', '1067337')
THEN "Black or African American"
WHEN RaceConceptId IN ('1067338', '1067339', '1067340', '1067341', '1067342', '1067343', '1067344', '1067345', '1067346', '1067347', '1067348', '1067349', '1067350', '1067351', '1067352', '1067353', '1067354', '1067355', '1067356', '1067357', '1067358', '1067359', '1067360', '1067361', '1067362', '1067363', '1067386')
THEN "Native Hawaiian or Other Pacific Islander"
WHEN RaceConceptId IN ('1067364', '1067365', '1067366', '1067367', '1067368', '1067369', '1067370', '1067371', '1067372', '1067373', '1067374', '1067375', '1067376', '1067377', '1067378', '1067379', '1067380', '1067381', '1067382', '1067383', '1067384')
THEN "White" 
WHEN RaceConceptId IN ('3056583')
THEN "Declined to answer"
WHEN RaceConceptId IN ('1067385')
THEN "Other Race"
WHEN RaceConceptId IN ('1067388')
THEN "Multiracial"
ELSE "Unknown or null flavor" END AS Race_cat
FROM cdh_truveta.PersonRace
